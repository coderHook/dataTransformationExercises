/**
 * @class Objnest
 * @param {object} config
 */
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var extend = require('extend');

var abind = require('abind');

var isArrayKey = require('./key/is_array_key');

var fromArrayKey = require('./key/from_array_key');

var toArrayKey = require('./key/to_array_key');

var isRecursive = function isRecursive(value) {
  if (!value) {
    return false;
  }

  var reservedClasses = [Date];
  var isReservedClass = reservedClasses.some(function (C) {
    return value instanceof C;
  });

  if (isReservedClass) {
    return false;
  }

  switch ((0, _typeof2.default)(value)) {
    case 'string':
    case 'number':
    case 'boolean':
    case 'function':
      return false;

    default:
      return true;
  }
};
/** @lends Objnest */


function Objnest(config) {
  extend(this, config || {});
  abind(this);
}

Objnest.prototype = {
  separator: '.',

  /**
   * @function expand
   * @param {object} object - Obj to flatten
   * @returns {object} Flatten obj.
   * @example
   *  const obj = objnest.expand({
   *      'foo.bar': 'baz'
   *  })
   *  console.log(obj) // => {foo: {bar: 'baz'}}
   */
  expand: function expand(object) {
    var _this = this;

    if (Array.isArray(object)) {
      return object.map(function (object) {
        return _this.expand(object);
      });
    }

    var separator = this.separator;
    var result = {};

    var _arr = Object.keys(object);

    for (var _i = 0; _i < _arr.length; _i++) {
      var key = _arr[_i];
      var val = object[key];
      var needsSeparate = !!~key.indexOf(separator);

      if (needsSeparate) {
        var subKeys = key.split(separator);
        var subObj = {};
        var thisKey = subKeys.shift();
        subObj[subKeys.join('.')] = val;
        var subExpandedObj = this.expand(subObj);
        var thisVal = result[thisKey];
        val = this._merge(thisVal, subExpandedObj);
        key = thisKey;
      }

      if (isArrayKey(key)) {
        var arrayKey = fromArrayKey(key);

        if (!result[arrayKey.name]) {
          var length = object["".concat(arrayKey.name, "[length]")] || 0;
          result[arrayKey.name] = new Array(length);
        }

        if (arrayKey.index !== null) {
          result[arrayKey.name][arrayKey.index] = this._merge(result[arrayKey.name][arrayKey.index], val);
        }
      } else {
        result[key] = val;
      }
    }

    return result;
  },

  /**
   * Flatten nested object.
   * @param {object} nested - Object to flatten.
   * @returns {object} - Flattened object.
   * @example
   *  const flattened = objnest.flatten({
   *      'foo': {'bar': 'baz'}
   *  })
   *  console.log(flattened) // => {'foo.bar': 'baz'}
   */
  flatten: function flatten(nested) {
    if (typeof nested === 'string') {
      return nested;
    }

    var separator = this.separator;
    var flattened = {};

    var _arr2 = Object.keys(nested || {});

    for (var _i2 = 0; _i2 < _arr2.length; _i2++) {
      var key = _arr2[_i2];
      var value = nested[key];

      if (value === null) {
        flattened[key] = value;
        continue;
      }

      if (isRecursive(value)) {
        var subValues = this.flatten(value);
        var isArray = Array.isArray(value);

        if (isArray) {
          flattened["".concat(key, "[length]")] = value.length;
        }

        var _arr3 = Object.keys(subValues);

        for (var _i3 = 0; _i3 < _arr3.length; _i3++) {
          var subKey = _arr3[_i3];
          var fullKey = void 0;

          if (isArray) {
            fullKey = key + toArrayKey(subKey);
          } else {
            fullKey = [key, subKey].join(separator);
          }

          flattened[fullKey] = subValues[subKey];
        }
      } else {
        flattened[key] = value;
      }
    }

    return flattened;
  },
  _merge: function _merge(v1, v2) {
    if (typeof v1 === 'undefined') {
      return v2;
    }

    if (typeof v2 === 'undefined') {
      return v1;
    }

    return extend(true, v1, v2 || {});
  }
};
module.exports = Objnest;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9iam5lc3QuanMiXSwibmFtZXMiOlsiZXh0ZW5kIiwicmVxdWlyZSIsImFiaW5kIiwiaXNBcnJheUtleSIsImZyb21BcnJheUtleSIsInRvQXJyYXlLZXkiLCJpc1JlY3Vyc2l2ZSIsInZhbHVlIiwicmVzZXJ2ZWRDbGFzc2VzIiwiRGF0ZSIsImlzUmVzZXJ2ZWRDbGFzcyIsInNvbWUiLCJDIiwiT2JqbmVzdCIsImNvbmZpZyIsInByb3RvdHlwZSIsInNlcGFyYXRvciIsImV4cGFuZCIsIm9iamVjdCIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsInJlc3VsdCIsIk9iamVjdCIsImtleXMiLCJrZXkiLCJ2YWwiLCJuZWVkc1NlcGFyYXRlIiwiaW5kZXhPZiIsInN1YktleXMiLCJzcGxpdCIsInN1Yk9iaiIsInRoaXNLZXkiLCJzaGlmdCIsImpvaW4iLCJzdWJFeHBhbmRlZE9iaiIsInRoaXNWYWwiLCJfbWVyZ2UiLCJhcnJheUtleSIsIm5hbWUiLCJsZW5ndGgiLCJpbmRleCIsImZsYXR0ZW4iLCJuZXN0ZWQiLCJmbGF0dGVuZWQiLCJzdWJWYWx1ZXMiLCJzdWJLZXkiLCJmdWxsS2V5IiwidjEiLCJ2MiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBSUE7Ozs7OztBQUVBLElBQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O0FBQ0EsSUFBTUMsS0FBSyxHQUFHRCxPQUFPLENBQUMsT0FBRCxDQUFyQjs7QUFDQSxJQUFNRSxVQUFVLEdBQUdGLE9BQU8sQ0FBQyxvQkFBRCxDQUExQjs7QUFDQSxJQUFNRyxZQUFZLEdBQUdILE9BQU8sQ0FBQyxzQkFBRCxDQUE1Qjs7QUFDQSxJQUFNSSxVQUFVLEdBQUdKLE9BQU8sQ0FBQyxvQkFBRCxDQUExQjs7QUFFQSxJQUFNSyxXQUFXLEdBQUcsU0FBZEEsV0FBYyxDQUFDQyxLQUFELEVBQVc7QUFDN0IsTUFBSSxDQUFDQSxLQUFMLEVBQVk7QUFDVixXQUFPLEtBQVA7QUFD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WixDQU5DOztBQU10QixxREFBNkM7QUFBeEMsY0FBTUMsTUFBTSxhQUFaO0FBQ0gsY0FBSUMsT0FBTyxTQUFYOztBQUNBLGNBQUkzQixPQUFKLEVBQWE7QUFDWDJCLFlBQUFBLE9BQU8sR0FBR3RCLEdBQUcsR0FBR3BCLFVBQVUsQ0FBQ3lDLE1BQUQsQ0FBMUI7QUFDRCxXQUZELE1BRU87QUFDTEMsWUFBQUEsT0FBTyxHQUFHLENBQUN0QixHQUFELEVBQU1xQixNQUFOLEVBQWNaLElBQWQsQ0FBbUJsQixTQUFuQixDQUFWO0FBQ0Q7O0FBQ0Q0QixVQUFBQSxTQUFTLENBQUNHLE9BQUQsQ0FBVCxHQUFxQkYsU0FBUyxDQUFDQyxNQUFELENBQTlCO0FBQ0Q7QUFDRixPQWZELE1BZU87QUFDTEYsUUFBQUEsU0FBUyxDQUFDbkIsR0FBRCxDQUFULEdBQWlCbEIsS0FBakI7QUFDRDtBQUNGOztBQUNELFdBQU9xQyxTQUFQO0FBQ0QsR0EzRmlCO0FBNEZsQlAsRUFBQUEsTUE1RmtCLGtCQTRGVlcsRUE1RlUsRUE0Rk5DLEVBNUZNLEVBNEZGO0FBQ2QsUUFBSSxPQUFPRCxFQUFQLEtBQWMsV0FBbEIsRUFBK0I7QUFDN0IsYUFBT0MsRUFBUDtBQUNEOztBQUNELFFBQUksT0FBT0EsRUFBUCxLQUFjLFdBQWxCLEVBQStCO0FBQzdCLGFBQU9ELEVBQVA7QUFDRDs7QUFDRCxXQUFPaEQsTUFBTSxDQUFDLElBQUQsRUFBT2dELEVBQVAsRUFBV0MsRUFBRSxJQUFJLEVBQWpCLENBQWI7QUFDRDtBQXBHaUIsQ0FBcEI7QUF1R0FDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnRDLE9BQWpCIiwic291cmNlUm9vdCI6Ii4uLy4uL2xpYiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGNsYXNzIE9iam5lc3RcbiAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWdcbiAqL1xuJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IGV4dGVuZCA9IHJlcXVpcmUoJ2V4dGVuZCcpXG5jb25zdCBhYmluZCA9IHJlcXVpcmUoJ2FiaW5kJylcbmNvbnN0IGlzQXJyYXlLZXkgPSByZXF1aXJlKCcuL2tleS9pc19hcnJheV9rZXknKVxuY29uc3QgZnJvbUFycmF5S2V5ID0gcmVxdWlyZSgnLi9rZXkvZnJvbV9hcnJheV9rZXknKVxuY29uc3QgdG9BcnJheUtleSA9IHJlcXVpcmUoJy4va2V5L3RvX2FycmF5X2tleScpXG5cbmNvbnN0IGlzUmVjdXJzaXZlID0gKHZhbHVlKSA9PiB7XG4gIGlmICghdmFsdWUpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuICBjb25zdCByZXNlcnZlZENsYXNzZXMgPSBbRGF0ZV1cbiAgY29uc3QgaXNSZXNlcnZlZENsYXNzID0gcmVzZXJ2ZWRDbGFzc2VzLnNvbWUoKEMpID0+IHZhbHVlIGluc3RhbmNlb2YgQylcbiAgaWYgKGlzUmVzZXJ2ZWRDbGFzcykge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG4gIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7XG4gICAgY2FzZSAnc3RyaW5nJzpcbiAgICBjYXNlICdudW1iZXInOlxuICAgIGNhc2UgJ2Jvb2xlYW4nOlxuICAgIGNhc2UgJ2Z1bmN0aW9uJzpcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gdHJ1ZVxuICB9XG59XG5cbi8qKiBAbGVuZHMgT2JqbmVzdCAqL1xuZnVuY3Rpb24gT2JqbmVzdCAoY29uZmlnKSB7XG4gIGV4dGVuZCh0aGlzLCBjb25maWcgfHwge30pXG4gIGFiaW5kKHRoaXMpXG59XG5cbk9iam5lc3QucHJvdG90eXBlID0ge1xuICBzZXBhcmF0b3I6ICcuJyxcbiAgLyoqXG4gICAqIEBmdW5jdGlvbiBleHBhbmRcbiAgICogQHBhcmFtIHtvYmplY3R9IG9iamVjdCAtIE9iaiB0byBmbGF0dGVuXG4gICAqIEByZXR1cm5zIHtvYmplY3R9IEZsYXR0ZW4gb2JqLlxuICAgKiBAZXhhbXBsZVxuICAgKiAgY29uc3Qgb2JqID0gb2JqbmVzdC5leHBhbmQoe1xuICAgKiAgICAgICdmb28uYmFyJzogJ2JheidcbiAgICogIH0pXG4gICAqICBjb25zb2xlLmxvZyhvYmopIC8vID0+IHtmb286IHtiYXI6ICdiYXonfX1cbiAgICovXG4gIGV4cGFuZCAob2JqZWN0KSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkob2JqZWN0KSkge1xuICAgICAgcmV0dXJuIG9iamVjdC5tYXAoKG9iamVjdCkgPT4gdGhpcy5leHBhbmQob2JqZWN0KSlcbiAgICB9XG4gICAgY29uc3Qgc2VwYXJhdG9yID0gdGhpcy5zZXBhcmF0b3JcbiAgICBjb25zdCByZXN1bHQgPSB7fVxuICAgIGZvciAobGV0IGtleSBvZiBPYmplY3Qua2V5cyhvYmplY3QpKSB7XG4gICAgICBsZXQgdmFsID0gb2JqZWN0W2tleV1cbiAgICAgIGNvbnN0IG5lZWRzU2VwYXJhdGUgPSAhIX5rZXkuaW5kZXhPZihzZXBhcmF0b3IpXG4gICAgICBpZiAobmVlZHNTZXBhcmF0ZSkge1xuICAgICAgICBjb25zdCBzdWJLZXlzID0ga2V5LnNwbGl0KHNlcGFyYXRvcilcbiAgICAgICAgY29uc3Qgc3ViT2JqID0ge31cbiAgICAgICAgY29uc3QgdGhpc0tleSA9IHN1YktleXMuc2hpZnQoKVxuICAgICAgICBzdWJPYmpbc3ViS2V5cy5qb2luKCcuJyldID0gdmFsXG4gICAgICAgIGNvbnN0IHN1YkV4cGFuZGVkT2JqID0gdGhpcy5leHBhbmQoc3ViT2JqKVxuICAgICAgICBjb25zdCB0aGlzVmFsID0gcmVzdWx0W3RoaXNLZXldXG4gICAgICAgIHZhbCA9IHRoaXMuX21lcmdlKHRoaXNWYWwsIHN1YkV4cGFuZGVkT2JqKVxuICAgICAgICBrZXkgPSB0aGlzS2V5XG4gICAgICB9XG4gICAgICBpZiAoaXNBcnJheUtleShrZXkpKSB7XG4gICAgICAgIGNvbnN0IGFycmF5S2V5ID0gZnJvbUFycmF5S2V5KGtleSlcbiAgICAgICAgaWYgKCFyZXN1bHRbYXJyYXlLZXkubmFtZV0pIHtcbiAgICAgICAgICBjb25zdCBsZW5ndGggPSBvYmplY3RbYCR7YXJyYXlLZXkubmFtZX1bbGVuZ3RoXWBdIHx8IDBcbiAgICAgICAgICByZXN1bHRbYXJyYXlLZXkubmFtZV0gPSBuZXcgQXJyYXkobGVuZ3RoKVxuICAgICAgICB9XG4gICAgICAgIGlmIChhcnJheUtleS5pbmRleCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdFthcnJheUtleS5uYW1lXVthcnJheUtleS5pbmRleF0gPSB0aGlzLl9tZXJnZShcbiAgICAgICAgICAgIHJlc3VsdFthcnJheUtleS5uYW1lXVthcnJheUtleS5pbmRleF0sXG4gICAgICAgICAgICB2YWxcbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdFtrZXldID0gdmFsXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRcbiAgfSxcbiAgLyoqXG4gICAqIEZsYXR0ZW4gbmVzdGVkIG9iamVjdC5cbiAgICogQHBhcmFtIHtvYmplY3R9IG5lc3RlZCAtIE9iamVjdCB0byBmbGF0dGVuLlxuICAgKiBAcmV0dXJucyB7b2JqZWN0fSAtIEZsYXR0ZW5lZCBvYmplY3QuXG4gICAqIEBleGFtcGxlXG4gICAqICBjb25zdCBmbGF0dGVuZWQgPSBvYmpuZXN0LmZsYXR0ZW4oe1xuICAgKiAgICAgICdmb28nOiB7J2Jhcic6ICdiYXonfVxuICAgKiAgfSlcbiAgICogIGNvbnNvbGUubG9nKGZsYXR0ZW5lZCkgLy8gPT4geydmb28uYmFyJzogJ2Jheid9XG4gICAqL1xuICBmbGF0dGVuIChuZXN0ZWQpIHtcbiAgICBpZiAodHlwZW9mIG5lc3RlZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBuZXN0ZWRcbiAgICB9XG4gICAgY29uc3Qgc2VwYXJhdG9yID0gdGhpcy5zZXBhcmF0b3JcbiAgICBjb25zdCBmbGF0dGVuZWQgPSB7fVxuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKG5lc3RlZCB8fCB7fSkpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gbmVzdGVkW2tleV1cbiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICBmbGF0dGVuZWRba2V5XSA9IHZhbHVlXG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG4gICAgICBpZiAoaXNSZWN1cnNpdmUodmFsdWUpKSB7XG4gICAgICAgIGNvbnN0IHN1YlZhbHVlcyA9IHRoaXMuZmxhdHRlbih2YWx1ZSlcbiAgICAgICAgY29uc3QgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkodmFsdWUpXG4gICAgICAgIGlmIChpc0FycmF5KSB7XG4gICAgICAgICAgZmxhdHRlbmVkW2Ake2tleX1bbGVuZ3RoXWBdID0gdmFsdWUubGVuZ3RoXG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBzdWJLZXkgb2YgT2JqZWN0LmtleXMoc3ViVmFsdWVzKSkge1xuICAgICAgICAgIGxldCBmdWxsS2V5XG4gICAgICAgICAgaWYgKGlzQXJyYXkpIHtcbiAgICAgICAgICAgIGZ1bGxLZXkgPSBrZXkgKyB0b0FycmF5S2V5KHN1YktleSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZnVsbEtleSA9IFtrZXksIHN1YktleV0uam9pbihzZXBhcmF0b3IpXG4gICAgICAgICAgfVxuICAgICAgICAgIGZsYXR0ZW5lZFtmdWxsS2V5XSA9IHN1YlZhbHVlc1tzdWJLZXldXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZsYXR0ZW5lZFtrZXldID0gdmFsdWVcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZsYXR0ZW5lZFxuICB9LFxuICBfbWVyZ2UgKHYxLCB2Mikge1xuICAgIGlmICh0eXBlb2YgdjEgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICByZXR1cm4gdjJcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB2MiA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybiB2MVxuICAgIH1cbiAgICByZXR1cm4gZXh0ZW5kKHRydWUsIHYxLCB2MiB8fCB7fSlcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE9iam5lc3RcbiJdfQ==